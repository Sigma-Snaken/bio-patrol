<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bio Patrol | Sigma Robotics</title>
  <link rel="stylesheet" href="css/style.css?v=2">
  <link rel="icon" href="assets/logo.png" type="image/png">
</head>
<body>

  <div class="app-container">

  <!-- ========== HEADER ========== -->
  <header class="glass-header">
    <div class="logo"><img src="assets/logo.png" alt="logo" class="logo-icon">生理量測巡房</div>
    <div class="tabs">
      <button class="tab-btn active" data-tab="dashboard" onclick="switchTab('dashboard')">Dashboard</button>
      <button class="tab-btn" data-tab="patrol" onclick="switchTab('patrol')">Patrol</button>
      <button class="tab-btn" data-tab="beds" onclick="switchTab('beds')">Beds</button>
      <button class="tab-btn" data-tab="sensor" onclick="switchTab('sensor')">Sensor</button>
      <button class="tab-btn" data-tab="settings" onclick="switchTab('settings')">Settings</button>
    </div>
    <div class="status-bar">
      <span class="status-item">
        <span class="label">Time</span>
        <span class="value" id="header-clock">--:--:--</span>
      </span>
      <span class="status-item">
        <span class="label">Battery</span>
        <span class="value" id="battery-value">--%</span>
      </span>
      <div class="connection-light" id="connection-status" title="Connection"></div>
    </div>
  </header>

  <!-- ========== MAIN CONTENT ========== -->
  <main class="main-content">

    <!-- ==================== TAB 1: DASHBOARD ==================== -->
    <div id="view-dashboard" class="tab-content no-padding active">
      <div class="split-view">
        <!-- LEFT: Map -->
        <div class="left-panel">
          <div class="map-container" id="map-container">
            <div class="loading-overlay" id="map-loading">
              <div class="spinner"></div>
              <p>Initializing Map</p>
            </div>
            <canvas id="map-canvas"></canvas>
          </div>
          <div class="controls-panel">
            <div style="display:flex;align-items:center;justify-content:space-between;width:100%;gap:16px;">
              <div style="display:flex;flex:1;gap:8px;">
                <button id="btn-home" class="btn-premium" style="flex:1;">
                  <span>⌂</span> Return Home
                </button>
                <button id="btn-cancel-command" class="btn-danger" style="flex:0 0 auto;padding:0 16px;" title="Emergency Stop">
                  <span>■</span>
                </button>
              </div>
              <div class="d-pad">
                <button class="up" onclick="manualControl('forward')" title="Forward">▲</button>
                <button class="left" onclick="manualControl('left')" title="Left">◀</button>
                <button class="down" onclick="manualControl('backward')" title="Backward">▼</button>
                <button class="right" onclick="manualControl('right')" title="Right">▶</button>
              </div>
            </div>
            <div class="info-text">
              <p>Click to Move • Drag to Set Pose</p>
              <p id="pose-display">X: -- Y: -- θ: --</p>
            </div>
          </div>
        </div>

        <!-- RIGHT: Monitor Panel -->
        <div class="right-panel">
          <div class="header"><h2>Monitor</h2></div>

          <!-- Bio Sensor Reading (collapsible) -->
          <div class="monitor-frame" id="bio-reading-frame">
            <div class="frame-header" onclick="toggleFrame('bio-reading-frame')">
              <h4>Latest Bio-Sensor <span class="toggle-icon">▼</span></h4>
            </div>
            <div class="frame-content">
              <div class="bio-reading">
                <div class="reading-item">
                  <div class="reading-value" id="bio-bpm">--</div>
                  <div class="reading-label">BPM</div>
                </div>
                <div class="reading-item">
                  <div class="reading-value" id="bio-rpm">--</div>
                  <div class="reading-label">RPM</div>
                </div>
                <div class="reading-item">
                  <div class="reading-value" id="bio-status">--</div>
                  <div class="reading-label">Status</div>
                </div>
              </div>
            </div>
          </div>

          <!-- Patrol Schedule -->
          <div class="monitor-frame" id="schedule-frame">
            <div class="frame-header" onclick="toggleFrame('schedule-frame')">
              <h4>Patrol Schedule <span class="toggle-icon">▼</span></h4>
            </div>
            <div class="frame-content">
              <div class="next-run-display">
                <span class="next-run-label">Next Patrol</span>
                <span class="next-run-value" id="next-run-time">--</span>
              </div>
              <div id="schedule-list"></div>
              <div style="padding:8px 14px;">
                <div style="display:flex;gap:6px;align-items:center;">
                  <input type="time" id="new-schedule-time" style="padding:5px 8px;background:var(--panel-light);border:1px solid var(--border-subtle);font-family:var(--font-mono);font-size:12px;flex:1;">
                  <select id="new-schedule-type" style="padding:5px 8px;background:var(--panel-light);border:1px solid var(--border-subtle);font-family:var(--font-mono);font-size:12px;">
                    <option value="daily">Daily</option>
                    <option value="weekday">Weekdays</option>
                  </select>
                  <button class="btn-secondary" onclick="addSchedule()">+</button>
                </div>
              </div>
            </div>
          </div>

          <!-- Quick Actions -->
          <div class="monitor-frame" id="quick-actions-frame">
            <div class="frame-header" onclick="toggleFrame('quick-actions-frame')">
              <h4>Quick Actions <span class="toggle-icon">▼</span></h4>
            </div>
            <div class="frame-content">
              <div class="quick-actions">
                <div class="action-row">
                  <button class="btn-action btn-action--primary" onclick="startDemoRun()">Demo Run</button>
                </div>
                <div class="action-row">
                  <button class="btn-action btn-action--accent" onclick="startPatrol()">Start Patrol</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== TAB 2: PATROL ==================== -->
    <div id="view-patrol" class="tab-content">
      <div>
        <!-- Demo / Presets -->
        <div class="glass-panel">
          <h3>Demo & Presets</h3>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <button class="btn-success" onclick="startDemoRun()">▶ Demo Run</button>
            <select id="patrol-preset-select" onchange="onPresetSelect(this.value)" style="padding:6px 10px;background:var(--panel-light);border:1px solid var(--border-subtle);color:var(--text-primary);font-family:var(--font-mono);font-size:12px;min-width:140px;">
              <option value="">-- Presets --</option>
            </select>
            <button class="btn-secondary" onclick="savePatrolPreset()">Save As...</button>
            <button class="btn-success" onclick="setDemoPreset()" title="Set selected preset as Demo route">Set Demo</button>
            <button class="btn-danger-sm" onclick="deletePatrolPreset()" title="Delete selected preset">✕</button>
          </div>
        </div>

        <!-- Patrol Bed Order (grouped by room) -->
        <div class="glass-panel">
          <h3>Patrol Route</h3>
          <div id="patrol-route-list">
            <!-- Populated by JS: patrol-room divs with nested patrol-bed-item -->
          </div>
        </div>
      </div>
    </div>

    <!-- ==================== TAB 3: BEDS ==================== -->
    <div id="view-beds" class="tab-content">
      <!-- Room Settings -->
      <div class="glass-panel">
        <h3>Room Configuration</h3>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;">
          <div class="form-group">
            <label>Room Count</label>
            <input type="number" id="beds-room-count" value="14" min="1">
          </div>
          <div class="form-group">
            <label>Starting Room Number</label>
            <input type="number" id="beds-room-start" value="101" min="1">
          </div>
          <div class="form-group">
            <label>Bed Numbers (comma-separated)</label>
            <input type="text" id="beds-bed-numbers" value="1,2,3,5,6" placeholder="e.g. 1,2,3,5,6">
          </div>
        </div>
        <div style="display:flex;gap:8px;margin-top:12px;">
          <button class="btn-premium" onclick="regenerateBeds()">Regenerate</button>
          <button class="btn-success" onclick="fetchRobotLocations()">Read from Robot</button>
          <button class="btn-secondary" onclick="saveBedsConfig()">Save Configuration</button>
        </div>
      </div>

      <!-- Beds Grid -->
      <div id="beds-grid-container">
        <!-- Populated by JS: room-section divs with beds-grid of bed-card items -->
      </div>
    </div>

    <!-- ==================== TAB 4: SENSOR ==================== -->
    <div id="view-sensor" class="tab-content">
      <!-- Stats Cards -->
      <div class="stats-grid" id="sensor-stats">
        <div class="stat-card">
          <div class="stat-value" id="stat-total-scans">0</div>
          <div class="stat-label">Total Scans</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-valid-scans">0</div>
          <div class="stat-label">Valid Scans</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-success-rate">0%</div>
          <div class="stat-label">Success Rate</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="stat-avg-bpm">--</div>
          <div class="stat-label">Avg BPM</div>
        </div>
      </div>

      <!-- Filter Controls -->
      <div class="sensor-controls">
        <label>Date</label>
        <input type="date" id="sensor-filter-date">
        <label>Limit</label>
        <input type="number" id="sensor-filter-limit" value="100" min="1" max="500" style="width:80px;">
        <button class="btn-secondary" onclick="loadSensorData()">Search</button>
        <button class="btn-secondary" onclick="clearSensorFilter()">Clear</button>
        <button class="btn-secondary" onclick="exportSensorCSV()">Export CSV</button>
      </div>

      <!-- Data Table -->
      <div class="table-container">
        <table class="data-table" id="sensor-table">
          <thead>
            <tr>
              <th>Patrol</th>
              <th>Time</th>
              <th>Bed</th>
              <th>Location ID</th>
              <th>Retry</th>
              <th>Status</th>
              <th>BPM</th>
              <th>RPM</th>
              <th>Valid</th>
              <th>Details</th>
            </tr>
          </thead>
          <tbody id="sensor-table-body">
          </tbody>
        </table>
      </div>
    </div>

    <!-- ==================== TAB 5: SETTINGS ==================== -->
    <div id="view-settings" class="tab-content">
      <div class="settings-two-column">
        <!-- LEFT COLUMN -->
        <div>
          <div class="glass-panel">
            <h3>Robot Connection</h3>
            <div class="form-group">
              <label>Robot IP Address</label>
              <input type="text" id="setting-robot-ip" placeholder="192.168.204.37:26400">
            </div>
            <div class="form-group">
              <label>Shelf ID</label>
              <div class="input-with-btn">
                <input type="text" id="setting-shelf-id" placeholder="e.g. S_04">
                <button type="button" class="btn-secondary" id="btn-fetch-shelves" onclick="fetchShelves()">Get Shelves</button>
              </div>
              <select id="shelf-select" class="shelf-dropdown" style="display:none;" onchange="applyShelfSelection()"></select>
            </div>
          </div>

          <div class="glass-panel">
            <h3>MQTT Configuration</h3>
            <div class="form-group">
              <label>MQTT Broker</label>
              <input type="text" id="setting-mqtt-broker" placeholder="localhost">
            </div>
            <div class="form-group">
              <label>MQTT Port</label>
              <input type="number" id="setting-mqtt-port" placeholder="1883">
            </div>
            <div class="form-group">
              <label>MQTT Topic</label>
              <input type="text" id="setting-mqtt-topic" placeholder="/data-test/demo/wisleep-eck/org/201906078">
            </div>
            <div class="form-group" style="display:flex;align-items:center;gap:12px;">
              <input type="checkbox" id="setting-mqtt-enabled" style="width:auto;">
              <label for="setting-mqtt-enabled" style="margin:0;cursor:pointer;">Enable MQTT</label>
            </div>
            <button class="btn-secondary" id="btn-test-mqtt" onclick="testMQTT()">Test Connection</button>
            <div class="log-display" id="mqtt-test-log"></div>
          </div>

          <div class="glass-panel">
            <h3>Bio-Sensor Timing</h3>
            <div class="form-group">
              <label>Scan Wait Time (seconds)</label>
              <input type="number" id="setting-bio-scan-wait-time" placeholder="10">
            </div>
            <div class="form-group">
              <label>Retry Count</label>
              <input type="number" id="setting-bio-scan-retry-count" placeholder="19">
            </div>
            <div class="form-group">
              <label>Initial Wait Time (seconds)</label>
              <input type="number" id="setting-bio-scan-initial-wait" placeholder="120">
            </div>
            <div class="form-group">
              <label>Valid Status Code</label>
              <input type="number" id="setting-bio-scan-valid-status" placeholder="4">
            </div>
            <button class="btn-secondary" id="btn-test-bioscan" onclick="testBioScan()">Test Bio-Scan</button>
            <p class="test-note">Uses saved settings. Save before testing.</p>
            <div class="log-display" id="bioscan-test-log"></div>
          </div>
        </div>

        <!-- RIGHT COLUMN -->
        <div>
          <div class="glass-panel">
            <h3>Robot Retry Settings</h3>
            <div class="form-group">
              <label>Max Retries</label>
              <input type="number" id="setting-robot-max-retries" placeholder="3">
            </div>
            <div class="form-group">
              <label>Retry Base Delay (seconds)</label>
              <input type="number" id="setting-robot-retry-base-delay" placeholder="2.0" step="0.1">
            </div>
            <div class="form-group">
              <label>Retry Max Delay (seconds)</label>
              <input type="number" id="setting-robot-retry-max-delay" placeholder="10.0" step="0.1">
            </div>
          </div>

          <div class="glass-panel">
            <h3>Telegram Notifications</h3>
            <div class="form-group" style="display:flex;align-items:center;gap:12px;">
              <input type="checkbox" id="setting-enable-telegram" style="width:auto;">
              <label for="setting-enable-telegram" style="margin:0;cursor:pointer;">Enable Telegram</label>
            </div>
            <div class="form-group">
              <label>Bot Token</label>
              <input type="password" id="setting-telegram-bot-token" placeholder="Enter bot token">
            </div>
            <div class="form-group">
              <label>User ID</label>
              <input type="text" id="setting-telegram-user-id" placeholder="Enter user ID">
            </div>
          </div>

          <div class="glass-panel">
            <h3>General</h3>
            <div class="form-group">
              <label>Timezone</label>
              <select id="setting-timezone">
                <option value="Asia/Taipei">Asia/Taipei (UTC+8)</option>
                <option value="Asia/Tokyo">Asia/Tokyo (UTC+9)</option>
                <option value="Asia/Shanghai">Asia/Shanghai (UTC+8)</option>
                <option value="Asia/Singapore">Asia/Singapore (UTC+8)</option>
                <option value="America/New_York">America/New_York (UTC-5)</option>
                <option value="America/Los_Angeles">America/Los_Angeles (UTC-8)</option>
                <option value="Europe/London">Europe/London (UTC+0)</option>
                <option value="UTC">UTC</option>
              </select>
            </div>
          </div>

          <div class="glass-panel">
            <h3>AI Integration</h3>
            <div class="form-group">
              <label>Gemini API Key</label>
              <input type="password" id="setting-gemini-api-key" placeholder="Enter API key">
            </div>
          </div>

          <div class="glass-panel">
            <h3>Map Management</h3>
            <button class="btn-secondary" id="btn-fetch-map" onclick="fetchMapFromRobot()">Fetch from Robot</button>
            <div id="map-list-container" style="margin-top:10px;">
              <p style="color:var(--text-muted);font-size:12px;">No saved maps</p>
            </div>
          </div>
        </div>
      </div>

      <div style="padding:0 16px 16px;">
        <button class="btn-premium" onclick="saveSettings()">Save Settings</button>
      </div>
    </div>

  </main>

  </div><!-- /.app-container -->

  <!-- ========== SHELF DROP ALERT MODAL ========== -->
  <div id="shelf-drop-overlay" class="alert-overlay" style="display:none">
    <div class="alert-modal alert-modal--wide">
      <h3>⚠️ 架子掉落警示</h3>
      <div class="shelf-drop-map-wrap">
        <canvas id="shelf-drop-map-canvas"></canvas>
      </div>
      <p>請依照地圖標示位置找到感測器並推回初始位置</p>
      <div id="shelf-drop-remaining" style="display:none;margin:12px 0;"></div>
      <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap;">
        <button class="btn-secondary" onclick="recoverShelf()">僅歸位感測器</button>
        <button class="btn-premium" id="btn-resume-patrol" onclick="resumePatrol()">歸位並繼續巡房</button>
      </div>
      <div id="shelf-recovery-status"></div>
    </div>
  </div>

  <!-- ========== SCRIPTS ========== -->
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="js/dataService.js?v=2"></script>
  <script src="js/script.js?v=2"></script>

</body>
</html>
